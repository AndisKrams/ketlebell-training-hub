{% extends 'base.html' %}
{% load static %}

{% block content %}
<div class="container mt-4 mb-2">
  <!-- Hidden form to render CSRF token into the page and ensure CSRF cookie is set for AJAX -->
  <form style="display:none">{% csrf_token %}</form>
  <div class="row justify-content-center">
    <div class="col-12 col-md-6 d-flex flex-column align-items-center mb-3 mb-md-0">
      <img src="{% static 'img/kettlebell.png' %}" alt="Kettlebell" class="img-fluid">
    </div>
    <div class="col-12 col-md-6">
      <div id="kettlebell-buttons" class="d-flex flex-row flex-wrap gap-2">
      {% for kettlebell in kettlebells %}
      <button type="button"
        class="kettlebell-btn btn m-0 p-2 {% if kettlebell.stock == 0 %}btn-secondary faded{% else %}btn-outline-dark{% endif %}"
        data-weight="{{ kettlebell.weight }}"
        data-weight-unit="{{ kettlebell.weight_unit }}"
        data-price="{{ kettlebell.price_gbp }}"
        data-stock="{{ kettlebell.stock }}"
        data-bs-toggle="tooltip"
        data-bs-html="true"
        title="{% if kettlebell.stock > 0 %}Price: £{{ kettlebell.price_gbp }}<br>{{ kettlebell.stock }} in stock<br><input type='number' min='1' max='{{ kettlebell.stock }}' value='1' class='form-control form-control-sm' style='width:70px;display:inline;'> <button class='btn btn-sm btn-secondary'>Add to basket</button>{% else %}<span class='text-danger'>Out of stock</span>{% endif %}">
  {{ kettlebell.weight }} {{ kettlebell.weight_unit }}
        {% if kettlebell.stock == 0 %}<span class="text-danger"> (Out of stock)</span>{% endif %}
      </button>
      {% endfor %}
      </div>
      <div id="kettlebell-details" class="mt-3"></div>
    </div>
  </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
  var buttons = document.querySelectorAll('.kettlebell-btn');
  var details = document.getElementById('kettlebell-details');
  buttons.forEach(function(btn) {
    btn.addEventListener('click', function() {
      var weight = btn.getAttribute('data-weight');
      var price = btn.getAttribute('data-price');
      var stock = btn.getAttribute('data-stock');
      if (stock > 0) {
        details.innerHTML = `
          <div class='card p-3'>
            <h5>${weight} ${btn.getAttribute("data-weight-unit") || "kg"}</h5>
            <p>Price: £${price}</p>
            <p>${stock} in stock</p>
        <form class='add-to-basket-form' data-weight='${weight}' data-weight-unit='${btn.getAttribute("data-weight-unit") || "kg"}'>
              <input name='quantity' type='number' min='1' max='${stock}' value='1' class='form-control form-control-sm mb-2' style='width:100px;display:inline-block;margin-right:8px;'>
              <button type='submit' class='btn btn-success'>Add to basket</button>
            </form>
          </div>`;
        // attach submit handler
        var form = details.querySelector('.add-to-basket-form');
        form.addEventListener('submit', function(e) {
          e.preventDefault();
          var qty = parseInt(form.querySelector("[name='quantity']").value || '0', 10);
          var csrftoken = (function(){
            return document.cookie.split('; ').find(row => row.startsWith('csrftoken='))?.split('=')[1];
          })();
          var unit = form.getAttribute('data-weight-unit') || 'kg';
          fetch('{% url "add_to_basket" %}', {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json',
              'X-CSRFToken': csrftoken,
            },
            body: JSON.stringify({weight: String(weight), unit: unit, quantity: qty})
          }).then(function(res){return res.json();}).then(function(data){
            if (data.ok) {
              try { window.showGlobalToast(`Added ${qty} x ${weight} ${unit} to basket`, 'success'); } catch (e) {}
              // clear the details area after showing toast to avoid stale inline messages
              details.innerHTML = '';
              // update the original button's data-stock and tooltip
              var btn = document.querySelector('.kettlebell-btn[data-weight="' + weight + '"][data-weight-unit="' + unit + '"]');
              if (btn && data.remaining_stock !== undefined) {
                btn.setAttribute('data-stock', String(data.remaining_stock));
                // update tooltip title if tooltip exists
                try {
                  const tip = bootstrap.Tooltip.getInstance(btn);
                  if (tip) {
                    const title = btn.getAttribute('title') || '';
                    // replace the stock number in title if present, fallback to rebuild
                    const newTitle = title.replace(/\d+ in stock/, data.remaining_stock + ' in stock');
                    btn.setAttribute('title', newTitle);
                    tip.setContent({'.tooltip-inner': newTitle});
                  }
                } catch (e) {
                  // ignore tooltip update errors
                }
              }
              // update header totals if provided
              if (data.grand_total !== undefined) {
                const totalEl = document.querySelector('#open-basket p');
                if (totalEl) totalEl.textContent = '£' + Number(data.grand_total).toFixed(2);
              }
              if (data.count !== undefined) {
                const badge = document.getElementById('basket-count');
                if (badge) badge.textContent = data.count;
              }
            } else {
              details.innerHTML = `<div class='alert alert-danger'>${data.error || 'Could not add to basket'}</div>`;
            }
          }).catch(function(){
            details.innerHTML = `<div class='alert alert-danger'>Network error</div>`;
          });
        });
      } else {
  details.innerHTML = `<div class='card p-3'><h5>${weight} ${btn.getAttribute("data-weight-unit") || "kg"}</h5><span class='text-danger'>Out of stock</span></div>`;
      }
    });
  });
  var tooltipTriggerList = [].slice.call(document.querySelectorAll('[data-bs-toggle="tooltip"]'));
  tooltipTriggerList.forEach(function (tooltipTriggerEl) {
    new bootstrap.Tooltip(tooltipTriggerEl);
  });
  // initialize header totals and badge
  (function(){
    fetch('{% url "basket:api_contents" %}')
      .then(r => r.json())
      .then(function(data){
        if (data && data.grand_total !== undefined) {
          const totalEl = document.querySelector('#open-basket p');
          if (totalEl) totalEl.textContent = '£' + data.grand_total.toFixed(2);
        }
        if (data && data.count !== undefined) {
          const badge = document.getElementById('basket-count');
          if (badge) badge.textContent = data.count;
        }
      }).catch(()=>{});
  })();
  // Clear the per-item add message when the basket updates elsewhere
  window.addEventListener('basket:updated', function(e) {
    try {
      const details = document.getElementById('kettlebell-details');
      const action = e && e.detail && e.detail.action ? e.detail.action : 'updated';
      // Remove per-item success message on remove/updated
      if (details) {
        const alert = details.querySelector('.alert.alert-success');
        if (alert && (action === 'removed' || action === 'updated')) alert.remove();
      }
      // If the basket was cleared, fully clear details and show a global toast (if toast helper exists)
      if (action === 'cleared') {
        if (details) details.innerHTML = '';
        try { window.showGlobalToast('Basket emptied', 'success'); } catch (e) {}
      }
    } catch (err) {
      // ignore
    }
  });
});
</script>
{% endblock %}